<!-- HTML header for doxygen 1.8.8-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <!-- For Mobile Devices -->
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
        <meta name="generator" content="Doxygen 1.8.11"/>
        <script type="text/javascript" src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
        <title>Loom: Loom: LLVM instrumentation library</title>
        <!--<link href="tabs.css" rel="stylesheet" type="text/css"/>-->
        <script type="text/javascript" src="dynsections.js"></script>
        <link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { init_search(); });
</script>
        <link href="doxygen.css" rel="stylesheet" type="text/css" />
        <link href='https://fonts.googleapis.com/css?family=Roboto+Slab' rel='stylesheet' type='text/css'>
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/css/bootstrap.min.css">
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/js/bootstrap.min.js"></script>
        <link rel="stylesheet" href="loom-dox.css"/>
        <script type="text/javascript" src="doxy-boot.js"></script>
    </head>
    <body>
        <nav class="navbar navbar-default" role="navigation">
            <div class="container">
                <div class="navbar-header">
                    <a class="navbar-brand" href="index.html">Loom </a>
                </div>
                <ul class="nav navbar-nav">
                    <li><a href="namespaces.html">Namespaces</a></li>
                    <li><a href="annotated.html">Classes</a></li>
                    <li><a href="files.html">Files</a></li>
                </ul>
            </div>
        </nav>
        <div id="top"><!-- do not remove this div, it is closed by doxygen! -->
            <div class="content" id="content">
                <div class="container">
                    <div class="row">
                        <div class="col-sm-12 panel " style="padding-bottom: 15px;">
                            <div style="margin-bottom: 15px;">
<!-- end header part -->
<!-- Generated by Doxygen 1.8.11 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li class="current"><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Loom: LLVM instrumentation library </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><div class="image">
<img src="https://raw.githubusercontent.com/cadets/loom/master/doc/images/loom-small.png"  align="right"/>
</div>
<p>Loom is a general-purpose library for adding instrumentation to software in the LLVM intermediate representation (IR) format. It is currently capable of generating static instrumentation points that expose values (e.g., function parameters and return values) to software-defined instrumentation functions.</p>
<p>Loom is part of the <a href="https://www.cl.cam.ac.uk/research/security/cadets">CADETS</a> (Causal, Adaptive, Distributed, and Efficient Tracing System) project as part of DARPA's <a href="http://www.darpa.mil/program/transparent-computing">Transparent Computing</a> program.</p>
<h2>Get it</h2>
<p>Loom itself is entirely contained within this GitHub repository, but it requires that you build <a href="http://llvm.org">LLVM</a> from source. In order to run Loom's test suite, you must also build a matching version of <a href="http://clang.llvm.org">Clang</a>.</p>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;$ git clone https://github.com/cadets/llvm -b cadets llvm</div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;$ git clone https://github.com/cadets/clang -b cadets llvm/tools/clang</div><div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;$ git clone https://github.com/cadets/loom loom</div></div><!-- fragment --><h2>Build it</h2>
<h3>Building Clang/LLVM</h3>
<p>First, build LLVM using <a href="https://cmake.org">CMake</a> and <a href="https://ninja-build.org">Ninja</a>. The directions below assume a <code>Release</code> build, but a <code>Debug</code> build is also possible.</p>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;$ mkdir llvm/Release</div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;$ cd llvm/Release</div><div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;$ cmake -G Ninja -D CMAKE_BUILD_TYPE=Release ..</div><div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;$ ninja</div><div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;[go get some coffee]</div></div><!-- fragment --><h3>Building LOOM</h3>
<ol type="1">
<li>Set your PATH to include the version of LLVM you just built: <div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;$ export PATH=/path/to/LLVM/Release/bin:$PATH</div></div><!-- fragment --> or: <div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;$ setenv PATH /path/to/LLVM/Release/bin:$PATH</div></div><!-- fragment --></li>
<li>Configure Loom build: <div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;$ cd /path/to/Loom</div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;$ mkdir Release</div><div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;$ cd Release</div><div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;$ cmake -G Ninja -D CMAKE_BUILD_TYPE=Release ..</div></div><!-- fragment --></li>
<li>Build Loom: <div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;$ ninja</div></div><!-- fragment --></li>
<li><p class="startli">(optional) run test suite:</p>
<p class="startli">a. Install <a href="https://github.com/Juniper/libxo">libxo</a>, which is used by Loom to emit structured output: </p><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;$ pkg install libxo    # or whatever your package manager command is</div></div><!-- fragment --><p> b. Run the Loom test suite: </p><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;$ ninja check</div></div><!-- fragment --></li>
</ol>
<h2>Use it</h2>
<h3><code>opt</code> pass</h3>
<p>Loom is structured as a set of libraries for LLVM instrumentation, but can be run most straightforwardly as an LLVM <a href="http://llvm.org/docs/CommandGuide/opt.html">opt</a> pass. This requires creating an instrumentation policy file such as: </p><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;#</div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;# There are two instrumentation strategies:</div><div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;#  * callout:  call an instrumentation function like __loom_called_foo</div><div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;#  * inline    inject instrumentation inline with instrumented events</div><div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;#</div><div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;strategy: callout</div><div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;</div><div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;#</div><div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;# When using callout instrumentation, the generated instrumentation functions</div><div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;# are named __loom_{event-specific-name} by default. This configuration value</div><div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;# allows the `__loom` prefix to be overridden.</div><div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;#</div><div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;hook_prefix: __test_hook</div><div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;</div><div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;#</div><div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;# Loom can automatically log events and their immediate values (e.g., when</div><div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;# logging a call to foo(1, 2, 3.1415), emit &quot;foo&quot;, 1, 2 and 3.1415) without</div><div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;# any processing. Strategies include:</div><div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;#</div><div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;#  * none      do not use the simple logger</div><div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;#  * printf    just print the event using printf()</div><div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;#  * xo        use libxo to emit a structured representation (e.g., json)</div><div class="line"><a name="l00023"></a><span class="lineno">   23</span>&#160;#</div><div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;logging: printf</div><div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;</div><div class="line"><a name="l00026"></a><span class="lineno">   26</span>&#160;#</div><div class="line"><a name="l00027"></a><span class="lineno">   27</span>&#160;# Specify how/when functions should be instrumented.</div><div class="line"><a name="l00028"></a><span class="lineno">   28</span>&#160;#</div><div class="line"><a name="l00029"></a><span class="lineno">   29</span>&#160;# Functions can be instrumented on the caller side (before/after the call)</div><div class="line"><a name="l00030"></a><span class="lineno">   30</span>&#160;# or the callee side (function prelude / return sites). This configuration</div><div class="line"><a name="l00031"></a><span class="lineno">   31</span>&#160;# value should be a list of entries, each specifying:</div><div class="line"><a name="l00032"></a><span class="lineno">   32</span>&#160;#</div><div class="line"><a name="l00033"></a><span class="lineno">   33</span>&#160;#  * `name`: the name of the function being instrumented (language-mangled)</div><div class="line"><a name="l00034"></a><span class="lineno">   34</span>&#160;#  * `caller`: (optional) list of directions to instrument calls (entry/exit)</div><div class="line"><a name="l00035"></a><span class="lineno">   35</span>&#160;#  * `callee`: (optional) list of directions to instrument functions</div><div class="line"><a name="l00036"></a><span class="lineno">   36</span>&#160;#</div><div class="line"><a name="l00037"></a><span class="lineno">   37</span>&#160;functions:</div><div class="line"><a name="l00038"></a><span class="lineno">   38</span>&#160;    - name: foo</div><div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160;      caller: [ entry, exit ]</div><div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160;</div><div class="line"><a name="l00041"></a><span class="lineno">   41</span>&#160;    - name: bar</div><div class="line"><a name="l00042"></a><span class="lineno">   42</span>&#160;      caller: [ entry ]</div><div class="line"><a name="l00043"></a><span class="lineno">   43</span>&#160;      callee: [ exit ]</div><div class="line"><a name="l00044"></a><span class="lineno">   44</span>&#160;</div><div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160;#</div><div class="line"><a name="l00046"></a><span class="lineno">   46</span>&#160;# Specify how/when structure fields should be instrumented.</div><div class="line"><a name="l00047"></a><span class="lineno">   47</span>&#160;#</div><div class="line"><a name="l00048"></a><span class="lineno">   48</span>&#160;# We can instrument both reads and writes to structure fields.</div><div class="line"><a name="l00049"></a><span class="lineno">   49</span>&#160;# These fields must currently be identified by number rather than name.</div><div class="line"><a name="l00050"></a><span class="lineno">   50</span>&#160;# The `structures` config value is a list of entries containing:</div><div class="line"><a name="l00051"></a><span class="lineno">   51</span>&#160;#</div><div class="line"><a name="l00052"></a><span class="lineno">   52</span>&#160;#  * `name`: the structure name</div><div class="line"><a name="l00053"></a><span class="lineno">   53</span>&#160;#  * `fields`: a list of structure field descriptions:</div><div class="line"><a name="l00054"></a><span class="lineno">   54</span>&#160;#    * `name`: field name</div><div class="line"><a name="l00055"></a><span class="lineno">   55</span>&#160;#    * `operations`: list of operations to instrument (`read` or `write`)</div><div class="line"><a name="l00056"></a><span class="lineno">   56</span>&#160;#</div><div class="line"><a name="l00057"></a><span class="lineno">   57</span>&#160;structures:</div><div class="line"><a name="l00058"></a><span class="lineno">   58</span>&#160;  - name: baz</div><div class="line"><a name="l00059"></a><span class="lineno">   59</span>&#160;    fields:</div><div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160;      - name: refcount</div><div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160;        operations: [ read, write ]</div></div><!-- fragment --><p>and then running <code>opt</code>:</p>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;$ opt -load /path/to/LLVMLoom.so -loom -loom-file /path/to/instr.policy</div></div><!-- fragment --><p>Loom's <code>opt</code> pass has options that can be seen in the help/usage output:</p>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;$ opt -load /path/to/LLVMLoom.so -help | grep loom</div></div><!-- fragment --><h3>Instrumenting FreeBSD</h3>
<p>To build FreeBSD with Loom, you need to clone our <a href="https://github.com/cadets/freebsd/branches/loom">IR-augmented version of FreeBSD</a>. Then, you can use our <code>loom-fbsdmake</code> script as a drop-in wrapper around <code>make</code>:</p>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;$ git clone https://github.com/cadets/freebsd -b loom freebsd-loom</div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;$ cd freebsd-loom</div><div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;$ export LLVM_PREFIX=/path/to/LLVM/Release</div><div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;$ export LOOM_LIB=/path/to/Loom/Release/lib/LLVMLoom.so</div><div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;$ /path/to/Loom/scripts/loom-fbsdmake buildworld buildkernel</div><div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;$ /path/to/Loom/scripts/loom-fbsdmake buildenv   # etc.</div></div><!-- fragment --> </div></div><!-- contents -->
<!-- HTML footer for doxygen 1.8.8-->
<!-- start footer part -->
</div>
</div>
</div>
</div>
</div>
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.11
</small></address>
</body>
</html>
